import type { AnalysisReport, Finding } from '../types/index.js';

export function generateMarkdownReport(report: AnalysisReport): string {
  const lines: string[] = [];

  lines.push(`# âš¡ cpp-perf-audit Report`);
  lines.push('');
  lines.push(`| Property | Value |`);
  lines.push(`|----------|-------|`);
  lines.push(`| **Project** | ${report.project.name} |`);
  lines.push(`| **C++ Standard** | ${report.project.cppStandard} |`);
  lines.push(`| **Build System** | ${report.project.buildSystem} |`);
  lines.push(`| **Files Analyzed** | ${report.summary.filesAnalyzed} |`);
  lines.push(`| **Safety Score** | ${scoreEmoji(report.summary.score)} **${report.summary.score}/100** |`);
  lines.push(`| **Duration** | ${report.duration.toFixed(1)}s |`);
  lines.push('');

  lines.push('## Summary');
  lines.push('');
  lines.push(`| Severity | Count |`);
  lines.push(`|----------|-------|`);
  lines.push(`| ðŸ”´ Critical | ${report.summary.critical} |`);
  lines.push(`| ðŸŸ¡ Warning | ${report.summary.warning} |`);
  lines.push(`| ðŸ”µ Suggestion | ${report.summary.suggestion} |`);
  lines.push(`| ðŸŸ¢ Good | ${report.summary.good} |`);
  lines.push('');

  const grouped = groupBySeverity(report.findings);

  if (grouped.critical.length > 0) {
    lines.push('## ðŸ”´ Critical Issues');
    lines.push('');
    for (const f of grouped.critical) {
      lines.push(...renderFinding(f));
    }
  }

  if (grouped.warning.length > 0) {
    lines.push('## ðŸŸ¡ Warnings');
    lines.push('');
    for (const f of grouped.warning) {
      lines.push(...renderFinding(f));
    }
  }

  if (grouped.suggestion.length > 0) {
    lines.push('## ðŸ”µ Suggestions');
    lines.push('');
    for (const f of grouped.suggestion) {
      lines.push(...renderFinding(f));
    }
  }

  if (grouped.good.length > 0) {
    lines.push('## ðŸŸ¢ Good Patterns');
    lines.push('');
    for (const f of grouped.good) {
      lines.push(`- âœ… **${f.title}** â€” ${f.description}`);
    }
    lines.push('');
  }

  lines.push('---');
  lines.push(`*Generated by [cpp-perf-audit](https://github.com/cpp-perf-audit) at ${report.timestamp}*`);

  return lines.join('\n');
}

function renderFinding(finding: Finding): string[] {
  const lines: string[] = [];
  const location = finding.line ? `${finding.file}:${finding.line}` : finding.file;

  lines.push(`<details>`);
  lines.push(`<summary><strong>${finding.title}</strong> â€” <code>${location}</code></summary>`);
  lines.push('');
  lines.push(finding.description);
  lines.push('');

  if (finding.codeSnippet) {
    lines.push('**Problem:**');
    lines.push('```cpp');
    lines.push(finding.codeSnippet);
    lines.push('```');
    lines.push('');
  }

  if (finding.fix) {
    lines.push('**Fix:**');
    lines.push('```cpp');
    lines.push(finding.fix);
    lines.push('```');
    lines.push('');
  }

  if (finding.source) {
    lines.push(`> ðŸ“š Source: *${finding.source}*`);
    lines.push('');
  }

  lines.push('</details>');
  lines.push('');

  return lines;
}

function scoreEmoji(score: number): string {
  if (score >= 90) return 'ðŸ†';
  if (score >= 75) return 'ðŸ‘';
  if (score >= 50) return 'âš ï¸';
  return 'ðŸ”´';
}

function groupBySeverity(findings: Finding[]) {
  return {
    critical: findings.filter((f) => f.severity === 'critical'),
    warning: findings.filter((f) => f.severity === 'warning'),
    suggestion: findings.filter((f) => f.severity === 'suggestion'),
    good: findings.filter((f) => f.severity === 'good'),
  };
}
